<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WatchWithMe - Room</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>

<body class="bg-gray-900 text-white flex flex-col min-h-screen">
  <!-- Header -->
  <header class="bg-gray-800 px-6 py-4 flex justify-between items-center shadow-md">
    <h2 class="text-xl font-bold">🎬 WatchWithMe</h2>
    <span class="text-sm">👤 {{ username }} | 🛏️ Room: <strong>{{ room }}</strong></span>
  </header>

  <!-- Main Layout -->
  <main class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-4 p-4">
    <!-- Left: Video and Controls -->
    <div class="lg:col-span-2 space-y-4">
      <!-- Video Container -->
      <div class="aspect-w-16 aspect-h-9 bg-black rounded-lg overflow-hidden">
        <video id="localVideo" controls class="w-full h-full hidden rounded-lg"></video>
        <div id="playerContainer" class="w-full h-full">
          <div id="player"></div>
        </div>
      </div>

      <!-- Controls -->
      <form id="videoForm" class="flex gap-2 flex-wrap">
        <input type="text" id="videoUrl" placeholder="Paste YouTube URL" 
               class="flex-1 p-3 rounded bg-gray-700 border border-gray-600 placeholder-gray-400">
        <input type="file" id="localFile" accept="video/*"
               class="p-2 rounded bg-gray-700 border border-gray-600 text-sm">
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-semibold transition">Share</button>
      </form>
    </div>

    <!-- Right: Chat -->
    <div class="bg-gray-800 rounded-lg shadow-md flex flex-col h-full">
      <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-2 text-sm"></div>
      <form id="chatForm" class="flex gap-2 border-t border-gray-700 p-4">
        <input type="text" id="chatInput" placeholder="Type a message..."
               class="flex-1 p-2 rounded bg-gray-700 border border-gray-600 placeholder-gray-400">
        <button type="submit" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-semibold transition">Send</button>
      </form>
    </div>
  </main>

  <script>
    const socket = io();
    const username = "{{ username }}";
    const room = "{{ room }}";

    socket.emit('join', { username, room });

    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const messages = document.getElementById('messages');

    chatForm.addEventListener('submit', e => {
      e.preventDefault();
      const message = chatInput.value;
      if (message.trim()) {
        socket.emit('chat', { username, message, room });
        chatInput.value = '';
      }
    });

    socket.on('chat', data => {
      const msg = document.createElement('div');
      msg.innerHTML = `<strong>${data.username}</strong>: ${data.message}`;
      messages.appendChild(msg);
      messages.scrollTop = messages.scrollHeight;
    });

    const videoForm = document.getElementById('videoForm');
    const videoUrl = document.getElementById('videoUrl');
    const localFile = document.getElementById('localFile');
    const localVideo = document.getElementById('localVideo');
    const playerContainer = document.getElementById('playerContainer');
    let player;

    // YouTube API
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '360',
        width: '640',
        videoId: '',
        events: {
          onReady: onPlayerReady,
          onStateChange: onPlayerStateChange
        }
      });
    }

    function onPlayerReady(event) {
      setInterval(() => {
        const current = player.getCurrentTime();
        const state = player.getPlayerState();
        if (state === YT.PlayerState.PLAYING) {
          socket.emit('video-control', { action: 'play', currentTime: current, room });
        } else if (state === YT.PlayerState.PAUSED) {
          socket.emit('video-control', { action: 'pause', currentTime: current, room });
        }
      }, 1500);
    }

    function onPlayerStateChange() {}

    socket.on('video-control', data => {
      if (data.action === 'play') {
        if (player) {
          player.seekTo(data.currentTime, true);
          player.playVideo();
        } else {
          localVideo.currentTime = data.currentTime;
          localVideo.play();
        }
      } else if (data.action === 'pause') {
        if (player) {
          player.pauseVideo();
        } else {
          localVideo.pause();
        }
      }
    });

    // Video sharing
    videoForm.addEventListener('submit', e => {
      e.preventDefault();
      if (localFile.files.length > 0) {
        const file = localFile.files[0];
        const url = URL.createObjectURL(file);
        localVideo.src = url;
        localVideo.classList.remove('hidden');
        playerContainer.classList.add('hidden');
        localVideo.play();
        // Local video events
        localVideo.onplay = () => {
          socket.emit('video-control', { action: 'play', currentTime: localVideo.currentTime, room });
        };
        localVideo.onpause = () => {
          socket.emit('video-control', { action: 'pause', currentTime: localVideo.currentTime, room });
        };
      } else {
        const ytUrl = videoUrl.value;
        const videoId = extractVideoId(ytUrl);
        if (videoId) {
          player.loadVideoById(videoId);
          localVideo.classList.add('hidden');
          playerContainer.classList.remove('hidden');
          socket.emit('share-youtube', { url: ytUrl, room });
        }
      }
      videoUrl.value = '';
    });

    socket.on('share-youtube', data => {
      const videoId = extractVideoId(data.url);
      if (player && videoId) {
        player.loadVideoById(videoId);
        localVideo.classList.add('hidden');
        playerContainer.classList.remove('hidden');
      }
    });

    function extractVideoId(url) {
      const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
      return match ? match[1] : null;
    }
  </script>
</body>
</html>
